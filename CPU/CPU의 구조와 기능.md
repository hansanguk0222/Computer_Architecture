# CPU의 구조와 기능

컴퓨터는 CPU, memory, I/O 장치로 구성되어 있다. 그 중에서 CPU는 프로그램 수행이라는 기본적인 역할을 한다. 지금부터 CPU에 대해서 알아보자

<br>



## CPU의 세부 동작

CPU의 세부동작을 나열하면 다음과 같다.

1. 명령어 인출 : memory에서 명령어를 읽어온다.
2. 명령어 해독 : 수행해야 할 동작을 결정하기 위하여 명령어를 해독
3. 데이터 인출 : 명령어 실행을 ㅜ이하여 데이터가 필요한 경우 memory나 I/O 장치에서 데이터를 읽어옴
4. 데이터 처리 : 데이터에 대한 산술적 혹은 논리적 연산을 수행 
5. 데이터 저장 : 수행한 결과를 저장

위의 명령어 에서 1번과 2번은 모두 공통으로 수행되는 명령어이고 3번, 4번, 5번은 필요에 따라서 수행되는 명령어이다.

<br>



## CPU의 기본 구조

CPU의 구조는 다음과 같다.

![cpu구조1](https://github.com/hansanguk0222/Computer_Architecture/blob/master/git%EC%9E%90%EB%A3%8C/CPU/cpu%EA%B5%AC%EC%A1%B01.jpg?raw=true)



그림과 같이 CPU는 크게 ALU와 Register Set, Control Unit으로 이루어졌다.

* ALU
  * 산술 연산들과 논리 연산들을 수행하는 회로

* Register Set
  * register는 cpu의 내부 기억장치로 액세스 속도가 컴퓨터 기억 장치 중 가장 빠르다. 
  * 회로가 복잡하고 비교적 큰 공간을 차지해서 모든 기억 장치를 레지스터로 만들지 못함 
  * 지정된 용도로 사용되는 특수 목적용 레지스터와 적은 수의 일반 목적용 레지스터만을 사용
* Control Unit
  * 프로그램 코드를 해석하고 그것을 실행하기 위한 제어 신호를 순차적으로 발생하는 하드웨어 모듈
  * CPU의 기능이 많아질수록 복잡해짐

<br>



## 레지스터의 구조

위에서 봤던 그림에서 레지스터를 종류별로 나누어 그림으로 알아보자. 그림에서 버스로 연결된 선들은 직접 연결된 곳이 아니면 연결되지 않았다.

<img src="https://github.com/hansanguk0222/Computer_Architecture/blob/master/git%EC%9E%90%EB%A3%8C/CPU/cpu%EA%B5%AC%EC%A1%B02.jpg?raw=true" alt="cpu구조2" style="zoom: 80%;" />



그림과 같이 CPU의 레지스터는 다음과 같다

* PC
  * 다음에 인출될 명령어의 주소를 가지는 레지스터
  * 명령어가 인출된 후에 그 내용이 자동적으로 1이나 word크기만큼 증가\
  * 분기 명령어가 실행되면 그 곳으로 목적지 주소를 갱신
* AC
  * 데이터를 일시적으로 저장하는 레지스터
  * AC의 비트 수는 word의 길이와 같다.
* IR
  * 가장 최근에 인출된 명령어가 저장되어 있는 레지스터
  * 다음에 수행할 명령어가 가지고 있다.
* MAR
  * PC에 저장된 명령어 주소가 시스템 주소 버스로 출력되기 전에 일시적으로 저장되는 주소 레지스터
  * MAR의 출력 선들이 주소 버스 선들과 직접 접속
* MBR
  * 기억장치에 저장될 데이터 혹은 기억장치로부터 읽혀진 데이터가 일시적으로 저장되는 버퍼 레지스터
  * MBR의 입출력 선들이 데이터 버스 선들과 직접 접속

<br>



## 명령어 실행

레지스터 구조를 파악했으니 이제는 명령어가 실행되는 과정을 생각해보자. 기본적인 명령어가 실행되는 과정은 다음과 같다.

![명령어 실행 다이어그램](https://github.com/hansanguk0222/Computer_Architecture/blob/master/git%EC%9E%90%EB%A3%8C/CPU/%EB%AA%85%EB%A0%B9%EC%96%B4%EC%8B%A4%ED%96%891.png?raw=true)



CPU가 한 개의 명령어를 실행하는데 필요한 전체 과정을 명령어 사이클이라고 한다. CPU가 기억 장치로부터 명령어를 읽어 오는 행위를 명령엉 인출이라하고 인출된 명령어를 실행하는 행위를 명령어 실행이라고 한다. 이 그림에서 인터럽트나 간접 사이클이 추가될 수도 있다.



명령어가 실행될 때 CPU의 레지스터 내부에서 일어나는 일은 다음과 같다.

1. 기억장치에서 인출된 명령어는 MBR을 경유하여 IR에 저장된다.
2. IR에 저장된 명령어는 Control Unit으로 보내져 해독된다. 
3. 기억장치로부터 인출될 명령어가 있으면 MBR을 경유하여 AC로 적재된다.
4. 3번에서 AC가 산술 혹은 논리 연산을 수행하는 것이라면 AC의 내용이 ALU로 보내진다. 
5. 4번에 결과로 나온 ALU의 결과는 다시 AC에 저장된다.

<br>



## 명령어 사이클의 각 부 사이클에 대한 동작

명령어 사이클 종류에 대하여 조금 깊게 더 공부해보자. 명령어 사이클의 부 사이클 종류는 크게 인출 사이클, 실행 사이클, 인터럽트 사이클, 간접 사이클이 있다. 다음은 각각의 부 사이클에 대하여 설명한 것이다. 각 설명에서 t0, t1, t2는 클록의 각 주기를 말한다.



* 인출 사이클

  * CPU가 각 명령어 사이클의 시작 단계에서 PC가 가리키는 기억 장치 위치로부터 명령어를 인출하는 과정

  * CPU는 PC의 내용을 1이나 word만큼 증가

  * ```javascript
    //t0 : MAR <- PC
    //t1 : MBR <- M[MAR], PC <- PC + 1
    //t2 : IR <- MBR
    ```

* 실행 사이클

  * cpu가 인출된 명령어 코드를 해독하고 그 결과에 따라 필요한 연산을 수행한다.

  * 실행 사이클의 종류

    * 데이터 이동 : CPU와 기억장치 간 혹은 CPU와 I/O 장치 간에 데이터를 이동
    * 데이터 처리 : 데이터에 대하여 산술 혹은 논리 연산 수행
    * 데이터 저장 : 연산 결과 데이터 혹은 입력장치로부터 읽어들인 데이터를 기억장치에 저장
    * 프로그램 제어 : 프로그램의 실행 순서를 결정

  * ```javascript
    //데이터 이동(LOAD addr), addr은 명령어가 사용할 데이터가 저장되어 있는 기억장치의 주소
    //t0 : MAR <- IR(addr) 
    //t1 : MBR <- M[MAR]
    //t2 : AC <- MBR
    
    //데이터 저장(STA addr), addr은 명령어가 사용할 데이터가 저장되어 있는 기억장치의 주소
    //t0 : MAR <- IR(addr) 
    //t1 : MBR <- AC
    //t2 : M[MAR] <- MBR
    
    //데이터 처리(ADD addr), addr은 명령어가 사용할 데이터가 저장되어 있는 기억장치의 주소, ADD를 예로 듬
    //t0 : MAR <- IR(addr) 
    //t1 : MBR <- M[MAR]
    //t2 : AC <- AC + MBR
    
    //데이터 제어(JUMP addr), addr은 명령어가 사용할 데이터가 저장되어 있는 기억장치의 주소, JUMP를 예로 듬(분기 명령어)
    //t0 : PC <- IR(addr) 
    ```

* 인터럽트 사이클

  * 프로그램 처리 중에 CPU로 하여금 순차적인 명령어 실행을 중단하고 다른 프로그램을 처리하도록 요구하는 메커니즘
  * 인터럽트 서비스 루틴
    
    * 외부로부터 인터럽트가 들어오게 되면 CPU는 원래의 프로그램 수행을 중단하고 ,요구된 인터럽트를 처리해주기 위한 프로그램을 먼저 수행
  * 인터럽트 사이클
    
    * 인터럽트 요구 신호를 검사하고 현재의 PC 내용을 스태에 저장한 다음에 PC에 해당 ISR(인터럽트 서비스 루틴)의 시작 주소를 적재하는 과정
  * 다중 인터럽트
    
    * 인터럽트가 실행되는 동안 다른 인터럽트가 개입한 상황
  * 특수 목적 레지스터 SP를 이용하여 항상 SP를 메모리의 마지막 주소로 세팅해놓는다.
  * 명령어 실행 단계 후에 위치

  * ```javascript
    //t0 : MBR <- PC
    //t1 : MAR <- SP, PC <- ISR의 시작주소
    //t2 : M[MAR] <- MBR, SP <- SP - 1
    ```

* 간접 사이클

  * 실행 사이클이 시작되기 전에 데이터의 실제 주소를 기억장치로 부터 읽어오는 과정

  * 인출 사이클과 실행 사이클에 사이에 위치

  * 항상 수행되지 않고 명령어 내의 특정 비트가 1로 세트된 경우만 수행

  * 인출 사이클에서 읽혀져 IR에 적재되어 있는 명령어의 주소 필드 내용을 다시 기억장치로 보내어서, 데이터의 실제 주소를 인출하여 IR의 주소 필드에 저장

  * ```javascript
    //t0 : MAR <- IR(addr)
    //t1 : MBR <- M[MAR]
    //t2 : IR(addr) <- MBR
    ```

    

